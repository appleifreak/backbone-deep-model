/*jshint expr:true eqnull:true */
/**
 *
 * Backbone.DeepModel v0.11.1
 *
 * Copyright (c) 2013 Charles Davison, Pow Media Ltd
 *
 * https://github.com/powmedia/backbone-deep-model
 * Licensed under the MIT License
 */

(function(e){typeof define=="function"&&define.amd?define(["underscore","backbone"],e):typeof exports=="object"?module.exports=e(require("underscore"),require("backbone")):e(_,Backbone)})(function(e,t){function f(t){var n={},r=p.keyPathSeparator;for(var i in t){var s=t[i];if(s&&(s.constructor===Object||s.constructor===Array)&&!e.isEmpty(s)){var o=f(s);for(var u in o){var a=o[u];n[i+r+u]=a}}else n[i]=s}return n}function l(t,n,r){var i=p.keyPathSeparator,s=n?n.split(i):[],o=t;r||r===!1;for(var u=0,a=s.length;u<a;u++){if(r&&!e.has(o,s[u]))return!1;o=o[s[u]],o==null&&u<a-1&&(o={});if(typeof o=="undefined")return r?!0:o}return r?!0:o}function c(t,n,r,i){i=i||{};var s=p.keyPathSeparator,o=n?n.split(s):[],u=t;for(var a=0,f=o.length;a<f&&u!==undefined;a++){var l=o[a];if(a===f-1)i.unset?delete u[l]:u[l]=r;else{if(typeof u[l]=="undefined"||!e.isObject(u[l])){var c=o[a+1];u[l]=/^\d+$/.test(c)?[]:{}}u=u[l]}}}function h(e,t){c(e,t,null,{unset:!0})}var n,r,i,s,o,u,a=[].slice;i=function(n){var r,s;return!e.isObject(n)||e.isFunction(n)?n:n instanceof t.Collection||n instanceof t.Model?n:e.isDate(n)?new Date(n.getTime()):e.isRegExp(n)?new RegExp(n.source,n.toString().replace(/.*\//,"")):(s=e.isArray(n||e.isArguments(n)),r=function(e,t,n){return s?e.push(i(t)):e[n]=i(t),e},e.reduce(n,r,s?[]:{}))},u=function(t){return t==null?!1:(t.prototype==={}.prototype||t.prototype===Object.prototype)&&e.isObject(t)&&!e.isArray(t)&&!e.isFunction(t)&&!e.isDate(t)&&!e.isRegExp(t)&&!e.isArguments(t)},r=function(t){return e.filter(e.keys(t),function(e){return u(t[e])})},n=function(t){return e.filter(e.keys(t),function(n){return e.isArray(t[n])})},o=function(t,i,s){var u,a,f,l,c,h,p,d,v,m;s==null&&(s=20);if(s<=0)return console.warn("_.deepExtend(): Maximum depth of recursion hit."),e.extend(t,i);h=e.intersection(r(t),r(i)),a=function(e){return i[e]=o(t[e],i[e],s-1)};for(p=0,v=h.length;p<v;p++)c=h[p],a(c);l=e.intersection(n(t),n(i)),u=function(n){return i[n]=e.union(t[n],i[n])};for(d=0,m=l.length;d<m;d++)f=l[d],u(f);return e.extend(t,i)},s=function(){var t,n,r,s;r=2<=arguments.length?a.call(arguments,0,s=arguments.length-1):(s=0,[]),n=arguments[s++],e.isNumber(n)||(r.push(n),n=20);if(r.length<=1)return r[0];if(n<=0)return e.extend.apply(this,r);t=r.shift();while(r.length>0)t=o(t,i(r.shift()),n);return t},e.mixin({deepClone:i,isBasicObject:u,basicObjects:r,arrays:n,deepExtend:s});var p=t.Model.extend({constructor:function(t,n){var r,i=t||{};this.cid=e.uniqueId("c"),this.attributes={},n&&n.collection&&(this.collection=n.collection),n&&n.parse&&(i=this.parse(i,n)||{});if(r=e.result(this,"defaults"))i=e.deepExtend({},r,i);this.set(i,n),this.changed={},this.initialize.apply(this,arguments)},toJSON:function(t){return e.deepClone(this.attributes)},get:function(e){return l(this.attributes,e)},set:function(t,n,r){var i,s,o,u,a,d,v,m,g;if(t==null)return this;typeof t=="object"?(s=t,r=n||{}):(s={})[t]=n,r||(r={});if(!this._validate(s,r))return!1;o=r.unset,a=r.silent,g=r.shallow,u=[],d=this._changing,this._changing=!0,d||(this._previousAttributes=e.deepClone(this.attributes),this.changed={}),m=this.attributes,v=this._previousAttributes,this.idAttribute in s&&(this.id=s[this.idAttribute]),g||(s=f(s));for(i in s)n=s[i],e.isEqual(l(m,i),n)||u.push(i),e.isEqual(l(v,i),n)?h(this.changed,i):c(this.changed,i,n),o?h(m,i):c(m,i,n);if(!a){u.length&&(this._pending=!0);var y=p.keyPathSeparator,b={};for(var w=0,E=u.length;w<E;w++){var t=u[w];if(!b.hasOwnProperty(t)||!b[t])b[t]=!0,this.trigger("change:"+t,this,l(m,t),r);var S=t.split(y);for(var x=S.length-1;x>0;x--){var T=e.first(S,x).join(y),N=T+y+"*";if(!b.hasOwnProperty(N)||!b[N])b[N]=!0,this.trigger("change:"+N,this,l(m,T),r);if(!b.hasOwnProperty(T)||!b[T])b[T]=!0,this.trigger("change:"+T,this,l(m,T),r)}}}if(d)return this;if(!a)while(this._pending)this._pending=!1,this.trigger("change",this,r);return this._pending=!1,this._changing=!1,this},clear:function(t){var n={},r=f(this.attributes);for(var i in r)n[i]=void 0;return this.set(n,e.extend({},t,{unset:!0}))},hasChanged:function(t){return t==null?!e.isEmpty(this.changed):l(this.changed,t)!==undefined},changedAttributes:function(t){if(!t)return this.hasChanged()?f(this.changed):!1;var n=this._changing?this._previousAttributes:this.attributes;t=f(t),n=f(n);var r,i=!1;for(var s in t){if(e.isEqual(n[s],r=t[s]))continue;(i||(i={}))[s]=r}return i},previous:function(e){return e==null||!this._previousAttributes?null:l(this._previousAttributes,e)},previousAttributes:function(){return e.deepClone(this._previousAttributes)}});return p.keyPathSeparator=".",t.DeepModel=p,typeof module!="undefined"&&(module.exports=p),t})